using Domain.Models.Settings;
using Microsoft.Extensions.Logging;
using Microsoft.Extensions.Options;
using NSubstitute;

namespace Domain.Services.Tests
{
    public class ImagemServiceTests
    {
        private readonly ILogger<ImagemService> _logger;
        private readonly IOptions<StorageSettings> _options;
        private readonly ImagemService _imagemService;

        public ImagemServiceTests()
        {
            _logger = Substitute.For<ILogger<ImagemService>>();

            // Cria uma instância de StorageSettings com o diretório desejado
            var storageSettings = new StorageSettings { ImageDirectory = Path.Combine(Directory.GetCurrentDirectory(), "Images") };
            _options = Substitute.For<IOptions<StorageSettings>>();
            _options.Value.Returns(storageSettings);

            _imagemService = new ImagemService(_logger, _options);
        }

        [Fact]
        public async Task SalvarImagemCNHAsync_ShouldThrowException_WhenFormatUnsupported()
        {
            // Arrange
            string identificador = "entregador1";
            string base64ImagemCNH = "data:image/jpeg;base64,iVBORw0KGgoAAAANSUhEUgAAA..."; // Formato inválido

            // Act & Assert
            var exception = await Assert.ThrowsAsync<ArgumentException>(() => _imagemService.SalvarImagemCNHAsync(identificador, base64ImagemCNH));
            Assert.Equal("Formato de imagem não suportado. Apenas PNG e BMP são aceitos.", exception.Message);
            _logger.Received(1).LogWarning("Formato de imagem não suportado.");
        }

        [Fact]
        public async Task SalvarImagemCNHAsync_ShouldSavePngImage()
        {
            // Arrange
            string identificador = "entregador1";
            string base64ImagemCNH = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAABIAAAAKICAIAAACHSRZaAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAAFiUAABYlAUlSJPAAAA8oSURBVHhe7d3RraJQFEBR66Ig6rEamrEYRwFHjfrGp5OdkKz1pRc8/zv3grsjAAAACQEGAAAQEWAAAAARAQYAABARYAAAABEBBgAAEBFgAAAAEQEGAAAQEWAAAAARAQYAABARYAAAABEBBgAAEBFgAAAAEQEGAAAQEWAAAAARAQYAABARYAAAABEBBgAAEBFgAAAAEQEGAAAQEWAAAAARAQYAABARYAAAABEBBgAAEBFgAAAAEQEGAAAQEWAAAAARAQYAABARYAAAABEBBgAAEBFgAAAAEQEGAAAQEWAAAAARAQYAABARYAAAABEBBgAAEBFgAAAAEQEGAAAQEWAAAAARAQYAABARYAAAABEBBgAAEBFgAAAAEQEGAAAQEWAAAAARAQYAABARYAAAABEBBgAAEBFgAAAAEQEGAAAQEWAAAAARAQYAABARYAAAABEBBgAAEBFgAAAAEQEGAAAQEWAAAAARAQYAABARYAAAABEBBgAAEBFgAAAAEQEGAAAQEWAAAAARAQYAABARYAAAABEBBgAAEBFgAAAAEQEGAAAQEWAAAAARAQYAABARYAAAABEBBgAAEBFgAAAAEQEGAAAQEWAAAAARAQYAABARYAAAABEBBgAAEBFgAAAAEQEGAAAQEWAAAAARAQYAABARYAAAABEBBgAAEBFgAAAAEQEGAAAQEWAAAAARAQYAABARYAAAABEBBgAAEBFgAAAAEQEGAAAQEWAAAAARAQYAABARYAAAABEBBgAAEBFgAAAAEQEGAAAQEWAAAAARAQYAABARYAAAABEBBgAAEBFgAAAAEQEGmzaNu91u2B/Wr9/77wMBALgSYLBpAgwAYEsEGGyaAAMA2BIBBls1p9K9cVqvHQ/TOAzr6m4YxumuqA7Tfry5ul9+9sVAAADeIsBgsw7TNO3PUTSM+9PHkzWKDsvqury21nVXawmt69VTgS2XPh0IAMCbBBhs2pMTg0stXfeuTu6W5i8v6+mDgQAAvEuAwaY99tLSV+N0uDWdN63W25Z4GvbPDxF+MBAAgHcJMNi0x16aV576e9vh8gTYfKjwPqI+GggAwHsEGGzai1467289WG9Y3byI4/b3nw8EAOCfBBhs2mMv/e7xrMM84Ob2bwcCAPADAQab9qSOLs943W9QvdyxmovrOuD7gQAAvCTAYNuWHazdMI7j+d+57tf2y2vjl7OGa0Gdc+ryQvnLKcTb3vr1QAAA3ibAYOvmFxLOboro7n+Tz+V0fdfGD5cWvx0IAMC7BBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAARAQYAABARIABAABEBBgAAEBEgAEAAEQEGAAAQESAAQAAJI7HP1BRvTM6QbEzAAAAAElFTkSuQmCC";

            string expectedDirectory = _options.Value.ImageDirectory;
            string expectedFilePath = Path.Combine(expectedDirectory, $"{identificador}_CNH.png");

            // Clean up before test
            if (File.Exists(expectedFilePath))
            {
                File.Delete(expectedFilePath);
            }

            // Act
            var result = await _imagemService.SalvarImagemCNHAsync(identificador, base64ImagemCNH);

            // Assert
            Assert.Equal(expectedFilePath, result);
            Assert.True(File.Exists(expectedFilePath), "Arquivo PNG não foi criado.");
        }

        [Fact]
        public async Task SalvarImagemCNHAsync_ShouldSaveBmpImage()
        {
            // Arrange
            string identificador = "entregador1";
            string base64ImagemCNH = "data:image/bmp;base64,Qk1eAfZrWq0AAAAAAwAAAAAABAAAAAAAABAAAAAAABAAAAABAAEAAABAABQAAAAAABAAAAAAAABAAAAAQAABAAAAAQAABAAAAAAAABAAAAAQAABAAAAAAABAAAAAQAABAAAAAAABAAAAAAABAAA="; // Exemplo válido de BMP

            string expectedDirectory = _options.Value.ImageDirectory;
            string expectedFilePath = Path.Combine(expectedDirectory, $"{identificador}_CNH.bmp");

            // Clean up before test
            if (File.Exists(expectedFilePath))
            {
                File.Delete(expectedFilePath);
            }

            // Act
            var result = await _imagemService.SalvarImagemCNHAsync(identificador, base64ImagemCNH);

            // Assert
            Assert.Equal(expectedFilePath, result);
            Assert.True(File.Exists(expectedFilePath), "Arquivo BMP não foi criado.");
        }

        [Fact]
        public async Task SalvarImagemCNHAsync_ShouldCreateDirectory_WhenNotExists()
        {
            // Arrange
            string identificador = "entregador1";
            string base64ImagemCNH = "data:image/bmp;base64,Qk1eAfZrWq0AAAAAAwAAAAAABAAAAAAAABAAAAAAABAAAAABAAEAAABAABQAAAAAABAAAAAAAABAAAAAQAABAAAAAQAABAAAAAAAABAAAAAQAABAAAAAAABAAAAAQAABAAAAAAABAAAAAAABAAA="; // Exemplo válido de BMP
            
            string directoryPath = Path.Combine(Directory.GetCurrentDirectory(), "Images");

            string nomeArquivoEsperado = $"{identificador}_CNH.png";
            string caminhoCompletoEsperado = Path.Combine(directoryPath, nomeArquivoEsperado);

            var storageSettings = new StorageSettings { ImageDirectory = directoryPath };
            _options.Value.Returns(storageSettings);

            // Act
            await _imagemService.SalvarImagemCNHAsync(identificador, base64ImagemCNH);

            bool directoryExists = Directory.Exists(directoryPath);
            Console.WriteLine("O diretório foi criado: " + directoryExists);

            // Assert
            Assert.True(directoryExists, "O diretório não foi criado.");

            bool arquivoExiste = File.Exists(caminhoCompletoEsperado);
            Assert.True(arquivoExiste, $"A imagem não foi salva no caminho esperado: {caminhoCompletoEsperado}");

            if (directoryExists)
            {
                Directory.Delete(directoryPath, true);
            }
        }

    }
}
